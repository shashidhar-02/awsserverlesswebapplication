<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authenticating...</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="login-card">
            <h1>ðŸ”„ Authenticating...</h1>
            <p>Please wait while we log you in</p>
            <div class="loader"></div>
        </div>
    </div>

    <script>
        // Configuration - UPDATE THESE VALUES
        const config = {
            cognitoDomain: 'https://YOUR-DOMAIN.auth.REGION.amazoncognito.com',
            clientId: 'YOUR_CLIENT_ID',
            redirectUri: window.location.origin + '/callback.html'
        };

        // Extract authorization code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        if (error) {
            alert('Authentication error: ' + error);
            window.location.href = 'index.html';
        } else if (code) {
            // Exchange code for tokens
            exchangeCodeForTokens(code);
        } else {
            alert('No authorization code found');
            window.location.href = 'index.html';
        }

        async function exchangeCodeForTokens(code) {
            const tokenUrl = `${config.cognitoDomain}/oauth2/token`;
            
            const params = new URLSearchParams({
                grant_type: 'authorization_code',
                client_id: config.clientId,
                code: code,
                redirect_uri: config.redirectUri
            });

            try {
                const response = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: params
                });

                if (response.ok) {
                    const tokens = await response.json();
                    
                    // Store tokens
                    sessionStorage.setItem('idToken', tokens.id_token);
                    sessionStorage.setItem('accessToken', tokens.access_token);
                    sessionStorage.setItem('refreshToken', tokens.refresh_token);
                    
                    // Decode and store user info
                    const userInfo = parseJwt(tokens.id_token);
                    sessionStorage.setItem('userEmail', userInfo.email);
                    
                    // Redirect to tasks page
                    window.location.href = 'tasks.html';
                } else {
                    const errorData = await response.json();
                    console.error('Token exchange failed:', errorData);
                    alert('Login failed. Please try again.');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Error exchanging code for tokens:', error);
                alert('Login failed. Please try again.');
                window.location.href = 'index.html';
            }
        }

        // Helper function to parse JWT
        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
    </script>
</body>
</html>
